rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // High level rules
    function userIsOwner(owner) {
      // Ensure the User ID matches the Auth UID
      return owner == request.auth.uid;
    }

    function fingerprintIsValid(fingerprint) {
      // Make sure the ID is a valid sha1 hash
      // return fingerprint.matches("^[0-9a-f]{40}$");
      // Make sure the ID is a valid base64 endcoded sha256 hash
      return fingerprint.matches("^[0-9a-zA-Z\\+\\/]{43}=$");
    }
    
    // User data rules
    match /users/{userID} {
      function encPrivkeyPkcs8IsValid(encPrivkey) {
        // TODO: implement. For now, just check that it's not null
        return encPrivkey != null;
      }

      function passkeySaltIsValid(salt) {
        // TODO: implement. For now, just check that it's not null
        return salt != null;
      }

      // Ensure that the user document is allowed
      function userIsValid() {
        return userIsOwner(userID) &&
        fingerprintIsValid(request.resource.data["pubkey_fingerprint"]) &&
        encPrivkeyPkcs8IsValid(request.resource.data["enc_privkey_pkcs8"]) &&
        passkeySaltIsValid(request.resource.data["passkey_salt"]);
      }
      
      allow read: if userIsOwner(userID);
      allow write: if userIsValid();
    }

    // Bucket rules
    // TODO: regex inputs to buckets
    match /buckets/{bucketId} {
      // Any autenticated can create a bucket
      allow create: if request.auth != null;
      // But only the owner can read, update, and delete it
      allow read, write, update, delete: if request.auth != null && request.auth.uid == resource.data.owner;
    }

    // PubKey rules
    match /pubkeys/{pubkey_fingerprint}  {
      function pubkeyIsSpki(pubkey) {
        // TODO: Implement. For now, just check that it's not null
        return pubkey != null;
      }

      function pubkeyIsValid() {
        return fingerprintIsValid(pubkey_fingerprint) &&
        pubkeyIsSpki(request.resource.data["spki"]) &&
        userIsOwner(request.resource.data["owner"]);
      }

      allow read: if true;
      allow write, create, delete: if pubkeyIsValid();
    }
  }
}